<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>OSC Receiver (Browser)</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        body { font-family: system-ui, sans-serif; margin: 2rem; color: #222; }
        .status { margin-bottom: 1rem; padding: 0.5rem 0.75rem; border-radius: 6px; background: #f4f4f4; display: inline-block; }
        .ok { background: #e8f8ef; color: #106a39; }
        .warn { background: #fff4e5; color: #8a4b00; }
        pre { background: #111; color: #eee; padding: 1rem; border-radius: 6px; overflow: auto; }
        ul { list-style: none; padding: 0; }
        li { margin: 0.5rem 0; }
        .msg { border: 1px solid #ddd; border-radius: 6px; padding: 0.5rem 0.75rem; }
        .small { color: #666; font-size: 0.9em; }
    </style>
</head>
<body>
<h1>OSC Receiver</h1>
<div id="status" class="status warn">Connecting…</div>

<p class="small">
    This page connects to a WebSocket bridge and displays incoming OSC messages.
    Send OSC UDP messages to the server (default <code>localhost:57121</code>).
</p>

<h2>Latest message</h2>
<pre id="latest">No messages yet.</pre>

<h2>Log</h2>
<ul id="log"></ul>

<script>
    (function () {
        const statusEl = document.getElementById("status");
        const latestEl = document.getElementById("latest");
        const logEl = document.getElementById("log");

        function setStatus(text, ok) {
            statusEl.textContent = text;
            statusEl.className = "status " + (ok ? "ok" : "warn");
        }

        function addLog(entry) {
            const li = document.createElement("li");
            li.className = "msg";
            li.textContent = entry;
            logEl.prepend(li);
            // keep the log to a reasonable size
            while (logEl.children.length > 100) logEl.removeChild(logEl.lastChild);
        }

        function connect() {
            const proto = location.protocol === "https:" ? "wss" : "ws";
            const ws = new WebSocket(`${proto}://${location.host}/osc`);

            ws.addEventListener("open", () => {
                setStatus("Connected", true);
            });

            ws.addEventListener("message", (ev) => {
                try {
                    const payload = JSON.parse(ev.data);
                    if (payload.type === "osc") {
                        // payload.message is like: { address: "/path", args: [...] }
                        const pretty = JSON.stringify(payload.message, null, 2);
                        latestEl.textContent = pretty;
                        addLog(`${payload.message.address} ${JSON.stringify(payload.message.args)}`);
                    } else if (payload.type === "status") {
                        addLog(payload.message);
                    } else {
                        addLog(ev.data);
                    }
                } catch (e) {
                    addLog(ev.data);
                }
            });

            ws.addEventListener("close", () => {
                setStatus("Disconnected. Reconnecting in 2s…", false);
                setTimeout(connect, 2000);
            });

            ws.addEventListener("error", () => {
                // Let the close handler do the reconnect
            });
        }

        connect();
    })();
</script>
</body>
</html>